@model Inventory.Models.ViewModels.MobileCarTicket_VM
@{
    ViewBag.Title = "Mobile Car Ticket";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var _user = ViewBag.AppUser as Inventory.Models.ViewModels.UserWithRole;
}
<div class="margin-bottom-10">
    @if (_user.HasAccess("MobileCarTicket", "Search"))
    {
        <a href="@Url.Action("Search")" class="btn btn-sm" title="@Labels.search">@Labels.back_to_list</a>
    }
    @if (_user.HasAccess("MobileCarTicket", "Edit"))
    {
        <a href="@Url.Action("Edit", new { id=Model.MobileCarTicketID })" class="btn btn-sm blue" title="@Labels.edit"><i class="fa fa-edit"></i> @Labels.edit</a>
    }
    @if (_user.HasAccess("MobileCarTicket", "Print") && Model.IsApproved == true && Model.MobileCarID != null)
    {
        <button class="btn btn-sm btn-info" id="btn_print" data-filepath="" title="Print Ticket"><i class="fa fa-print"></i>@Labels.print_preview</button>
    }
    @if (_user.HasAccess("MobileCarTicket", "Print") && Model.IsApproved != true)
    {
        <button class="btn btn-sm btn-success" data-toggle="modal" id="btn_approve" data-id="@Model.MobileCarTicketID" title="Approve Ticket"><i class="fa fa-check"></i>Approve</button>
    }
    @if (_user.HasAccess("MobileCarTicket", "Print") && Model.IsApproved == null)
    {
        <button class="btn btn-sm btn-warning" id="btn_reject" data-id="@Model.MobileCarTicketID" title="Reject Ticket"><i class="fa fa-ban"></i>Reject</button>
    }
    @if (_user.HasAccess("MobileCarTicket", "Print") && Model.IsApproved == true)
    {
        <a href="#popup_assign_car" data-toggle="modal" class="btn btn-sm btn-secondary" id="btn_assign_car" data-id="@Model.MobileCarTicketID" title="Assign Car"><i class="fa fa-car"></i>Assign Car</a>
    }
    @if (_user.HasAccess("MobileCarTicket", "Print") && Model.MobileCarID != null)
   {
        <a href="#popup_record_end_km" data-toggle="modal" class="btn btn-sm btn-success" id="btn_assign_car" data-id="@Model.MobileCarTicketID" title="Assign Car"><i class="fa fa-tachometer"></i>Add End Kilometre</a>
    }
    @if (_user.HasAccess("MobileCarTicket", "Delete"))
    {
        <a href="@Url.Action("Delete", new { id=Model.MobileCarTicketID })" class="btn btn-sm btn-danger" style="margin:0px 100px;" id="btn_delete" title="@Labels.delete"><i class="fa fa-trash"></i> @Labels.delete</a>
    }
</div>

<div id="print_area" class="margin-top-20">
    <table class="table table-striped table-condensed margin-bottom-30" style="border-collapse: collapse; width:100%;">
        <tr>
            <td style="text-align:center; padding-top:30px;"><span>د کډوالو او بیرته راستنیدونکو وزارت</span></td>
            <td style="text-align:center;">
                <img width="70" height="70" src="~/Content/resources/img/morr.png" />
            </td>
            <td style="text-align:center; padding-top:30px;"><span>وزارت مهاجرین و عودت کنندګان</span></td>
        </tr>
    </table>
    <div style="direction:rtl;">
        <table border="1" class="table table-striped table-condensed table-bordered" style="border-collapse: collapse; width:100%; margin-top:20px;">
            <thead>
                <tr>
                    <th style="text-align:right;padding:10px; word-wrap:normal; width:20%;">Is Approved</th>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">
                        @(Model.IsApproved == true ? Labels.yes : Model.IsApproved == false ? Labels.no : Labels.pending)
                    </th>
                </tr> 
                <tr>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">@Labels.Department</th>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">@Model.DepartmentName</th>
                </tr>
                <tr>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">Person Assign Name</th>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">@Model.PersAssignedName</th>
                </tr>
                <tr>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">Person Assign Occuption</th>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">@Model.PersAssignedOccupation</th>
                </tr>
                <tr>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">Email Adrress</th>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">@Model.EmailAddress</th>
                </tr>
                <tr>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">Visiting Date</th>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">@Model.VisitingDate</th>
                </tr>
                <tr>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">Visiting Time</th>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">@Model.VisitingTime</th>
                </tr>
                <tr>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">Visiting Purpose</th>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">@Model.VisitingPurpose</th>
                </tr>
                <tr>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">Number Plate</th>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">@Model.NumberPlate</th>
                </tr> 
                <tr>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">Driver Name</th>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">@Model.DriverName</th>
                </tr> 
                <tr>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">Car Type</th>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">@Model.CarType</th>
                </tr> 
                <tr>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">Driver Phone Number</th>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">@Model.DriverPhoneNo</th>
                </tr>
                <tr>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">Start Kilometre</th>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">@Model.Startkm</th>
                </tr>
                <tr>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">End Kilometre</th>
                    <th style="text-align:right;padding:10px; word-wrap:normal;">@(Model.Endkm == 0 ? ' ' : @Model.Endkm)</th>
                </tr>
            </thead>
        </table>        
    </div>
</div>

<div class="modal fade" id="popup_assign_car" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog" style="width:600px;">
        <div class="modal-content">
            <div class="modal-header blue">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <label>
                    Assign Car
                </label>
            </div>
            <div class="portlet-body" style="padding: 0 15px;">
                <form id="assign_car_form" autocomplete="off" class="margin-top-10">
                    <section class="row" style="margin:10px;">
                        <div class="form-group">
                            <label>Car</label>
                            @Html.DropDownList("MobileCarID", ViewBag.CarDrp as SelectList, Labels.please_select, new { @class = "form-control input-sm", @required = "required" ,@ID = "MobileCarID" })
                        </div>
                        <div class="form-group">
                            <label>Start Kilometer</label>
                            <input type="number" name="Startkm" id="Startkm" value="" required class="form-control input-sm" data-msg="" placeholder="Start km">
                        </div>
                    </section>
                    <section class="row">
                        <div class="col-md-12 form-group" style="margin-left:10px; margin-right:10px;">
                            <button type="submit" class="btn btn-sm blue ">@Labels.save</button>
                            <button type="reset" id="btnReset" class="btn btn-sm ">@Labels.reset</button>
                            <input type="hidden" name="MobileCarTicketID" id="MobileCarTicketID" value="@Model.MobileCarTicketID" />
                        </div>
                    </section>
                </form>

            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="popup_record_end_km" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog" style="width:500px;">
        <div class="modal-content">
            <div class="modal-header blue">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <label>
                    Record End Kilometre
                </label>
            </div>
            <div class="portlet-body" style="padding: 0 15px;">
                <form id="end_km_form" autocomplete="off" class="margin-top-10">
                    <section class="row" style="margin:10px;">
                        <div class="form-group">
                            <label>Start Kilometer</label>
                            <input type="number" name="Endkm" id="Endkm" value="" required class="form-control input-sm" data-msg="" placeholder="End km">
                        </div>
                    </section>
                    <section class="row">
                        <div class="col-md-12 form-group" style="margin-left:10px; margin-right:10px;">
                            <button type="submit" class="btn btn-sm blue ">@Labels.save</button>
                            <button type="reset" id="btnReset" class="btn btn-sm ">@Labels.reset</button>
                            <input type="hidden" name="MobileCarTicketID" id="MobileCarTicketID" value="@Model.MobileCarTicketID" />
                        </div>
                    </section>
                </form>

            </div>
        </div>
    </div>
</div>

@section scripts{
<script type="text/javascript">
    $(function () {
        // FORM VALIDATION AND SUBMISSION
        $('#assign_car_form').validate({
            submitHandler: function (form) {
                var data = $('#assign_car_form').serializeJSON({
                    parseAll: true,
                    useIntKeysAsArrayIndex: true,
                });
                var formData = ObjectToFormData(data);
                //******************
                Metronic.blockUI({ animate: true });
                $.ajax({
                    url: '@Url.Action("AssignCar")',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response != false) {
                            toastr.success("@Labels.operation_done_suc");
                            window.location.reload();
                        } else {
                            toastr.error('@Labels.unable_to_update');
                        }
                    },
                    complete: function () {
                        Metronic.unblockUI();
                    }
                })
            }
        })
        $('#end_km_form').validate({
            submitHandler: function (form) {
                var data = $('#end_km_form').serializeJSON({
                    parseAll: true,
                    useIntKeysAsArrayIndex: true,
                });
                var formData = ObjectToFormData(data);
                //******************
                Metronic.blockUI({ animate: true });
                $.ajax({
                    url: '@Url.Action("RecordEndkm")',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response != false) {
                            toastr.success("@Labels.operation_done_suc");
                            window.location.reload();
                        } else {
                            toastr.error('@Labels.unable_to_update');
                        }
                    },
                    complete: function () {
                        Metronic.unblockUI();
                    }
                })
            }
        })
            $('body').on('click', '#btn_delete', function (e) {
                e.preventDefault();
                var url = $(this).attr('href');
                bootbox.confirm('@Labels.are_you_sure', function (result) {
                    if (result == true) {
                        $.get(url, function (response) {
                            if (response == true) {
                                toastr.success("@Labels.operation_done_suc");
                                window.location.href = '@Url.Action("Search")';
                            }
                        })
                    } else {
                        toastr.error('Unable to delete');
                    }
                })
            })
            $('#btn_print').click(function (e) {
                var divToPrint = $("#print_area").html();
                var newWin = window.open("");
                newWin.document.write(divToPrint);
                newWin.print();
                newWin.close();
            })

            $("#btn_approve").click(function (e) {
                e.preventDefault();
                var id = $(this).data().id;
                var url = "@Url.Action("ApproveRejectTicket")/" + id + '?value=true';
                bootbox.confirm("@Labels.are_you_sure", function (result) {
                    if (result == true) {
                        $.get(url, function (response) {
                            if (response == true) {
                                toastr.success("@Labels.operation_done_suc");
                                var sendApprovedMailUrl = "@Url.Action("SendTicketApproveMail")/"+id;
                                $.get(sendApprovedMailUrl, function (response) {
                                    if (response == false) {
                                        toastr.error('Un able to send approve notification email to requester.');
                                    }
                                });
                                setTimeout(function () {
                                    window.location.reload();
                                }, 2000);
                            } else {
                                toastr.error('Unable to approve ticket');
                            }
                        })
                    }
                })
            })

        $("#btn_reject").click(function (e) {
            e.preventDefault();
            var id = $(this).data().id;
            var url = "@Url.Action("ApproveRejectTicket")/" + id + '?value=false';
            bootbox.confirm("@Labels.are_you_sure", function (result) {
                if (result == true) {
                    $.get(url, function (response) {
                        if (response == true) {
                            toastr.success("@Labels.operation_done_suc");
                            window.location.reload();
                        } else {
                            toastr.error('Unable to reject ticket');
                        }
                    })
                }
            })
        })
        })
</script>
}